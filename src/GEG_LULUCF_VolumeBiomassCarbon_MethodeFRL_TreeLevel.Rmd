---
title: "Volume, biomassa en koolstofgehalte volgens FRL en INBO-advies A.3104 (methode 4b)"
author: "Anja Leyman, Leen Govaere"
date: "`r Sys.Date()`"
output:
  html_document:
    number_sections: yes
    fig_caption: yes
    code_folding: hide
    toc: TRUE
    toc_float:
      collapsed: FALSE
      smooth_scroll: FALSE

---

```{r Rm}
rm(list=ls())
run <- 'test_LG'
```


```{r Setup, include = FALSE}

library(knitr)
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE, 
  fig.width = 9,
  fig.align = TRUE)

library(tidyverse)
library(RODBC)
library(here)
library(DT)
library(openssl)
library(kableExtra)
library(lme4)

#run_by <- 'AL'
run_by <- 'LG'
run <- 'run_LG'

source(here::here('Scripts/bestandsnamen_invoergegevens.R'))
source(here::here('Scripts/VBI_Functies.R'))
source(here::here('Scripts/VBI3_Functies.R'))

vec <- c(1, 100, 150, 175, 250, 300, 400, 800) # alle staande bomen, levend of dood

afgewerkt <- c(1,2) # wijzigt jaarlijks!
source(here::here('Scripts/VBI3_constanten.R'))


# ter vergelijking met cijfers advies : enkel VBI1 en VBI2

#afgewerkt <- c(0) 

```


# Vraagstelling

In het kader van de LULUCF-rapportering voor België worden door de VMM de emissies en verwijderingen (sinks) van broeikasgassen door landgebruik, veranderingen in landgebruik en bosbouw in Vlaanderen berekend. De koolstofopslag in Vlaamse bossen vormt hier een onderdeel van en wordt berekend met behulp van de Vlaamse Bosinventaris. Deze berekeningen schijnen uit te wijzen dat de koolstofopslag per ha aanzienlijk hoger is in Vlaamse dan in Waalse bossen.  Daarom heeft de VMM aan het INBO en ANB gevraagd om de methodiek door te lichten en indien nodig verbeteringen voor te stellen.

Dit heeft geleid tot het advies INBO A.3104.

Onderstaand script baseert zich op dit advies, en berekent **biomassa** en **koolstofgehalte (C)** volgens methode 4b uit het advies.
Bijkomend worden ook **stamvolume**, **stompvolume** en **totaal volume** (die de basis vormen van de biomassa-berekeningen) expliciet berekend.
Deze methode wordt gebruikt door ULG (Sébastien Bauwens) en voor de aanmaak van de FRL (Forest Reference Level).
Ook de VMM heeft na het INBO-advies beslist om deze methode te hanteren in het kader van de LULUCF-rapporteringen.

Conform het hoger vermeld advies worden **alle plots met verjonging en/of bomen > 7 cm dbh** bij de analyse betrokken. 
Of met andere woorden, alle plots waar een soort aan gekoppeld kan worden.
Dus zonder kaalslagen of tijdelijke open ruimtes.
Het advies INBO A.3104 heeft zich hiervoor dan weer gebaseerd op het INBO-advies A.3844 mbt volume hout in bossen in Vlaanderen. Ook daar worden enkel deze plots bij de analyse betrokken.


# Methodiek

**Algemeen**

De carbon uptake factor wordt berekend volgens de stock change methode (eq. 3.2.3. IPCC LULUCF): 

<!-- carbon uptake factor = (C2 - C1) / (t2 - t1) -->

<!-- $$\left(\frac{se_{V_{tot}}}{\hat{V}_{tot}}\right)^2 = \left(\frac{se_{V_{mean}}}{\hat{V}_{mean}}\right)^2  + \left(\frac{se_{A_{prod}}}{\hat{A_{prod}}}\right)^2$$ -->

$$\ C{{uptake}} = \frac{\left(\ C2 - C1 \right)}{\left(\ t2 - t1 \right)}$$


met 

- C~uptake~ = Carbon uptake factor (tC/ha/jaar)
- C1: carbon stock at time 1 (tC/ha)
- C2: carbon stock at time 1 (tC/ha)
- t1: time 1
- t2: time 2

en 

<!-- C = V * BEF * WD * (1 + R) * FC -->

$$\ C = \ V *  BEF * WD * \left(\ 1 + R \right) * FC$$

met 

- C = carbon stock (tC/ha)
- V = stamvolume > 7 cm (m³/ha)
- BEF = branch/biomass expansion factor: om het totale bovengrondse houtvolume (inclusief zwaar en dun kroonhout) te berekenen, vertrekkende van het stamvolume (diameter > 7 cm) 
- WD = wood density: om van volume naar biomassa over te gaan (t/m³)
- FC = carbon factor: ton C/ton droge biomassa (= 0.5)
- R = verhouding ondergrondse biomassa tov bovengrondse biomassa

<br>

**Verschillende methodes**

Vlaanderen en Wallonië gebruiken momenteel andere BEF's en WD's (verschillende bronnen).
Daarnaast zijn er ook wijzigingen doorheen de tijd.

De keuze van BEF en WD bepaalt sterk de uiteindelijke carbon uptake factor. 

In het INBO-advies A.3104 werden vier methodes (met variërende BEF en WD) met elkaar vergeleken:

1) conform huidige werkwijze VMM

2) conform methodiek beschreven in NIR 2020 voor Vlaanderen: mbv factoren zoals gebruikt in FRA 2010

3) conform methodiek beschreven in NIR 2020 voor Wallonië: mbv factoren van Valette en aangepaste wood density

4) conform de FRL: mbv BEF/VEF van Longuetaud (afh. van diameter en hoogte) + factoren cfr. FRL (R, FC, WD)
    - 4bis: FC = 0.5
    - 4tris: FC = 0.5 én WD = WD_FRA, zoals gebruikt bij NIR 2020 Vlaanderen

<br>

**Concreet**

In onderstaand script gaan we verder met methode 4b, conform de FRL: 
- BEF/VEF van Longuetaud: dit zijn variabele BEF's (afh. van diameter en hoogte)
- factoren cfr. FRL (R, FC, WD)
    - FC = 0.5

<br>
De factoren van Longuetaud zijn niet enkel boomsoort-afhankelijk, maar worden mede bepaald door diameter en hoogte van de boom.
Bijgevolg zijn we verplicht te vertrekken van individuele boommetingen (*tbl0Boom*).

<br>

# Referentie

Note technique version 20/11/2017. Estimation du volume et biomasse de différents compartiments de l’arbre. 
Accompagnement scientifique de l’IPRFW. Uliège - Wallonie environnement SPW.

<br>


# Invoer gegevens

```{r Data_path_v4, eval=FALSE, include=FALSE}
#lg ter vergelijking met cijfers advies : 
dbAnalyseData_path <- "C:/Users/govaerle/OneDrive - Vlaamse overheid - Office 365/BOSINVENTARISATIE/a_TEMP_GIT/04Bosinventarisatie_vrlp_v4_leen/Output/VBI_Analysedatabank_v2020-09-17.accdb"
dbAnalyseData <- "VBI_Analysedatabank_v2020-09-17.accdb"
dbMeetproces_path <- "C:/Users/govaerle/OneDrive - Vlaamse overheid - Office 365/BOSINVENTARISATIE/a_TEMP_GIT/04Bosinventarisatie_vrlp_v4_leen/Output/VBI_Meetproces_v2021-02-08.accdb"
dbMeetproces <- "VBI_Meetproces_v2021-02-08.accdb"


dbAnalyseDataTxt <- substring(dbAnalyseData_path, regexpr("/", dbAnalyseData_path) + 1)  

```

```{r}
#enkel van toepassing voor run v5--deze chunc uitzetten wanneer bovenstaande chunc actief is -- 
dbAnalyseData_path <- here::here(dbAnalyseData)
dbMeetproces_path <- here::here(dbMeetproces)

```

```{r Data_path}


dbResultaten_path <- here::here(dbResultaten)
dbExterneData_path <- here::here(dbExterneData) 

dbFactorsWallonia <- "Data/ExterneData/Wallonie_Biomass.accdb"
dbFactorsWallonia_path <- here::here(dbFactorsWallonia)

#dbAnalyseDataTxt <- substring(dbAnalyseData, regexpr("/", dbAnalyseData) + 1)  
dbMeetprocesTxt <- str_extract(dbMeetproces ,"VBI_Meetproces.+")
dbAnalyseDataTxt <- str_extract(dbAnalyseData ,"VBI_Analyse.+")
dbExterneDataTxt <- str_extract(dbExterneData, "VBIExterne.+")
#connectieResultatenTxt <- str_extract(dbResultaten, "resultaten.+")


```

Onderstaande tabel geeft een overzicht van de gegevens die gebruikt worden voor de analyse.  

```{r Data_overzicht}
data_overzicht <- data.frame(
  tabelnaam = c("tbl0Boom",  
                "tblRecordsVBI2+","tblPlotDetails", "tblPlotsWithMissingValues_Dendro",
                "tblBiomassExpFactors_TreeSpeciesGroups", 
                "tblCoefOmzetOmtrek",
                "Dico_Ess_Vlaanderen", 
                "EqnC0Biom", "EqnC10Biom", "EqnCrBiom", "EqnHtBiom", "EqnVEFBiom", "EqnWDBiom"),
  databanknaam = c(dbAnalyseDataTxt, 
                   dbMeetprocesTxt, dbMeetprocesTxt, dbMeetprocesTxt, 
                   dbExterneDataTxt, 
                   dbExterneDataTxt, 
                   dbFactorsWallonia, dbFactorsWallonia, dbFactorsWallonia, 
                   dbFactorsWallonia, dbFactorsWallonia, dbFactorsWallonia, 
                   dbFactorsWallonia),
  md5 = c(md5(dbAnalyseData_path), 
          md5(dbMeetproces_path), md5(dbMeetproces_path), md5(dbMeetproces_path),
          md5(dbExterneData_path), 
          md5(dbExterneData_path),
          md5(dbFactorsWallonia_path), md5(dbFactorsWallonia_path), md5(dbFactorsWallonia_path), 
          md5(dbFactorsWallonia_path), md5(dbFactorsWallonia_path), md5(dbFactorsWallonia_path), 
          md5(dbFactorsWallonia_path)
          )
)
          
data_overzicht %>%
  kable() %>%
  kable_styling()

```


```{r ConnectieAnalyseData}

connectieAnalyseData <- odbcConnectAccess2007(dbAnalyseData_path)

tbl_boom <- sqlFetch(connectieAnalyseData, "tbl0Boom")
tbl_boomsoort <- sqlFetch(connectieAnalyseData, "tbl10Boomsoorten")
#tbl_kwant <- sqlFetch(connectieAnalyseData, "tbl3BestandskaraktKwant")

odbcClose(connectieAnalyseData)

```

```{r ConnectieExterneData}

connectieExterneData <- odbcConnectAccess2007(dbExterneData_path) 

# SpeciesChar <- sqlFetch(connectieExterneData, "tblTreeSpeciesCharacteristics")
Species_BiomassFactors <- sqlFetch(connectieExterneData, "tblBiomassExpFactors_TreeSpeciesGroups")

convC130<-sqlFetch(connectieExterneData,"tblCoefOmzetOmtrek")

odbcClose(connectieExterneData)
```

```{r ConnectieFactorsWallonia}

ConnectieFactorsWallonia <- odbcConnectAccess2007(dbFactorsWallonia_path) 

Species_BiomassFactors_FRL <- sqlFetch(ConnectieFactorsWallonia, "Dico_Ess_Vlaanderen")
EqnC0Biom <- sqlFetch(ConnectieFactorsWallonia, "EqnC0Biom")
EqnC10Biom <- sqlFetch(ConnectieFactorsWallonia, "EqnC10Biom")
EqnCrBiom <- sqlFetch(ConnectieFactorsWallonia, "EqnCrBiom")
EqnHtBiom <- sqlFetch(ConnectieFactorsWallonia, "EqnHtBiom")
EqnVEFBiom <- sqlFetch(ConnectieFactorsWallonia, "EqnVEFBiom")
EqnWDBiom <- sqlFetch(ConnectieFactorsWallonia, "EqnWDBiom")

odbcClose(ConnectieFactorsWallonia)

# WD en R koppelen aan soorten
names(EqnWDBiom)
names(Species_BiomassFactors_FRL)
BiomassFactors4_FRL <- Species_BiomassFactors_FRL %>% 
  left_join(EqnWDBiom, by = c("eq_wd" = "id")) %>% 
  dplyr::rename(WD_FRL = mean_wd,
                R_FRL = BEF2) %>% 
  dplyr::select(-WD, -BEF1)

```

```{r ConnectieResultaten}

connectieResultaten <- odbcConnectAccess2007(dbResultaten_path)
bosopp <- sqlFetch(connectieResultaten, "tblResultaten_toestand", rownames = F) %>%
      filter(scriptNaam == "1_a_bosopp_toestand.R" & variabele == "bosOppervlakte" & strata == " ") %>%
      dplyr::select(-datum) %>%
      unique()

odbcClose(connectieResultaten)


```




```{r ConnectieMeetproces}

connectieMeetproces <- odbcConnectAccess2007(dbMeetproces_path)

tbl_NA <- sqlFetch(connectieMeetproces, "tblPlotsWithMissingValues_Dendro", stringsAsFactors = TRUE)

#v5
tbl_RecordVBI23 <- sqlFetch(connectieMeetproces, "tblRecordsVBI23", stringsAsFactors = TRUE)
tbl_RecordVBI1 <- sqlFetch(connectieMeetproces, "tblRecordsVBI1", stringsAsFactors = TRUE)
#v4
#tbl_RecordVBI23 <-  sqlFetch(connectieMeetproces, "tblRecordsVBI2+", stringsAsFactors = TRUE) # ter vergelijking v4

tbl_PlotDetails <- sqlFetch(connectieMeetproces, "tblPlotDetails", stringsAsFactors = TRUE)    # date_dendro
invb <- sqlFetch(connectieMeetproces, "invb")
MeetnetDetails <- sqlFetch(connectieMeetproces, "MeetnetDetails")

odbcClose(connectieMeetproces)
```



v5 : Aanpassen naamgeving zonder hoofdlettergebruik naar hoofdletters :

```{r}
colnames(tbl_PlotDetails) <- c("IDPlots"
                           , "Periode"
                           , "DateDendro"
                           , "DateVeg"
                           , "DateReg"
                           , "datedendroday"
                           , "datevegday"
                           , "dateregday"
                           ,  "StartPeriode"
                           , "IDGroup"
                           , "fase2_forest"
                           , "PlotRelocated"
                           , "PlotReplaced")

colnames(tbl_RecordVBI23) <- c("IDPlots"
                               , "IDSegments"
                               , "Periode"
                               , "fase2_forest"
                               , "Landuse"
                               , "StandDescriptionRecord"
                               , "DendroRecord"
                               , "DendroRecordZero"
                               , "DendroNonresponsType"
                               , "RegRecord"
                               , "RegRecordZero"
                               , "RegNonResponsType"
                               , "LIMRecord"
                               , "LIMRecordZero"
                               , "LIMNonResponsType"
                               , "VegRecord"
                               , "VegRecordZero"
                               , "HerbRecord"
                               , "HerbRecordZero"
                               , "HerbNonResponsType")
```

# Controle: ontbrekende waarden nakijken

<!-- Enkel levende en staande, dode bomen -->
<!-- Datum opname en reeks toevoegen  -->

```{r Add_Plotdetails}
tbl_boom <- tbl_boom %>% 
    filter(NewOrMissingTree %in% vec | is.na(NewOrMissingTree)) %>% 
   left_join(tbl_PlotDetails[, c("IDPlots", "Periode", "DateDendro")], by = c("IDPlots", "Periode")) %>%
   left_join(invb %>% dplyr::select(IDPlots = PLOTNR, REEKS), by = "IDPlots") 
  
```

<!-- Ontbrekende waarden controleren -->

```{r CheckMissingValues}
check_SpeciesGroup <- sum(is.na(tbl_boom$SpeciesGroup)) == 0
check_StatusTreeCode <- sum(is.na(tbl_boom$StatusTreeCode)) == 0
check_v3_Volume_ha <- sum(is.na(tbl_boom$Volume_m3)) == 0
# nakijken --> veel NA's --> moeten dit nullen zijn?
check_DateDendro <- sum(is.na(tbl_boom$DateDendro)) == 0
check_PlotWeight <- sum(is.na(tbl_boom$PlotWeight)) == 0
check_SegmentWeight <- sum(is.na(tbl_boom$SegmentWeight)) == 0
```

We vinden in *tbl0Boom* `r sum(is.na(tbl_boom$Volume_m3))` ontbrekende waarden voor variabele *Volume_m3*. 
Dit zijn bomen met een ontbrekende waarde voor species of omtrek. Voor dergelijke plots werden alle dendrometrische attributen voor alle bomen als NA aangeduid (tblPlotsWithMissingValues_Dendro). Dergelijke plots worden uit de analyse geweerd.

```{r CheckMissingVol_Periode2, echo=FALSE}

NA_CheckVBI2 <- tbl_boom %>%
    filter(Periode == 2) %>%
    filter(is.na(Volume_m3)) %>% # dit waren eerder de 28 plots waar een diameter niet opgemeten/opgeslagen is, PlotsToDrop en weggelaten
    inner_join(tbl_RecordVBI23, by = c("Periode", "IDPlots", "IDSegments")) %>%
    #v5 dplyr::select(IDPlots, Periode, DendroNonresponsType, RegNonResponsType, HerbNonResponsType, DendroRecord, DendroRecordZero, RegRecordZero, Volume_m3) %>%
    #v4 dplyr::select(IDPlots, Periode, A34NONRESPONSTYPE, A2NONRESPONSTYPE, VEGNONRESPONSTYPE, OPMERKING, DendroRecord, DendroRecordZero, RegRecordZero, Volume_m3) %>%
    filter(DendroRecord == TRUE) %>%
    unique() %>% # 28 observaties met DendroRecord = TRUE, maw opgemeten en NA's voor volume? 
    left_join(tbl_NA, by = c("Periode", "IDPlots")) %>%
    filter(is.na(NrOfTreesWithNA)) %>%
    unique()

# dit zijn/waren de 28 VBI2 + x voor VBI3 plots waar een diameter niet opgemeten/opgeslagen is
NA_CheckVBI2$IDPlots %>% unique()
```


```{r tbl_boom_NA}
tbl_boom_notNA <- tbl_boom %>%
  filter(!is.na(PlotWeight),
         !is.na(SegmentWeight),
         !is.na(DateDendro),
         !is.na(SpeciesGroup),
         !is.na(Volume_m3),
         !is.na(StatusTreeCode))
```


```{r RemovePlotsWithMissingValues, results = 'hide'}
# onvolledig om enkel de bomen zonder diameter te verwijderen, de volledige plot dient verwijderd te worden

tbl_boom_notNA <- tbl_boom_notNA %>% 
  anti_join(tbl_NA, by = c("IDPlots", "Periode"))

tbl_boom_notNA %>% inner_join(tbl_NA, by = c("IDPlots", "Periode")) %>% nrow()

```

# Overzicht gebruikte factoren

```{r OverzichtGebruikteFactoren}
# Methode FRL (= methode 4): 
#   - VEF = f(D, H) => wordt hier niet opgenomen
#   - Wél de wood density én de FC (0.47)

FactorsPerMethod <- Species_BiomassFactors %>% 
  left_join(BiomassFactors4_FRL %>% dplyr::select(IDTreeSp, WD_FRL, R_FRL), by = c("IDTreeSp")) %>%  
  dplyr::select(IDTreeSp, NameNl, 
         WD4= WD_FRL, R4= R_FRL) %>% 
  mutate(WD4 = round(WD4, 2))

```


```{r TableFactoren}

FactorsPerMethod %>% 
            DT::datatable(options = list(pageLength = 12, order = list(0, 'asc'), scrollX = TRUE), rownames = FALSE, filter = "top")

write_excel_csv2(FactorsPerMethod,here::here("Output/Tabellen_tmp/BiomassFactorsMethode_FRL.csv"))

```

Het overzicht met gebruikte factoren wordt weggeschreven naar "BiomassFactorsMethode_FRL.csv".


# Analyse

## Berekeningen op boomniveau - methode 4

Aangezien de methode van de FRL gebruik maakt van expansiefactoren die afhankelijk zijn van diameter en boomhoogte, vertrekken we van *tbl0Boom* (boomniveau).

We selecteren enkel de levende bomen.

```{r trees_living}
trees_living <- tbl_boom_notNA %>%
  filter(StatusTreeCode == 1) %>% 
  dplyr::select(-BOOMNR_VBI1_A2, -X_m, -Y_m, -NewOrMissingTree)

```

De methode die we hierna volgen, baseert zich op de berekening van het forest reference level (FRL; Wallonië en Vlaanderen).
<br>

Volgende stappen worden doorlopen:

- berekening van VEF~Longuetaud~ = diameter- en hoogte-afhankelijke expansiefactoren (VEF : volume expansion factor)
- mbv deze VEF: van stamhout naar totaal volume (inclusief smaller kroonhout)
- mbv wood density naar biomassa/ha (WD)
- mbv R: inschatting ondergrondse biomassa
- mbv FC naar carbon/ha (C/ha)


<br>

<!-- #### Overzicht te volgen stappen -->

<!-- Vertrekkende van diameter en hoogte in tbl0Boom -->

<!-- 6 tabellen met parameters uit vergelijkingen -->
<!-- - EqnC0Biom: 12 groepen (code - cfr. "code", b0, b1, b2 -->

<!-- - EqnC10Biom: 12 groepen, b0, b1, b2, b3, b4, b5 -->

<!-- - EqnCrBiom: 12 groepen én 10 'pc' (10, 20, ..100), b0, b1, b2 -->

<!-- - EqnHtBiom: 14 groepen, a, b, c -->

<!-- - EqnVEFBiom: 12 groepen, b1, b2, b3, b4 -->

<!-- - EqnWDBiom: 1 per boomsoort  -->

<!-- Overzicht van alle sooorten met link naar de te gebruiken vergelijkingen -->

<!-- Dico_ess: overzicht van de "essences":  -->
<!-- - NumEquation: 1-14: link naar gebruikte curves -->
<!-- - veld "eq_ht" = link naar veld "id" in tabel EqnHtBiom -->
<!-- - veld "eq_cir" = link naar veld "id" in tabel Eqn????   -->

<!-- EqnC0Biom: id -->
<!-- EqnC10Biom: ID -->
<!-- EqnCrBiom: code (+ uniek veld id + pc telkens 10, 20, ...100) -->

<!-- - veld "eq_VEF" = link naar veld "id" in tabel EqnVEFBiom -->
<!-- - veld "eq_wd" = link naar veld "id" in tabel EqnWDBiom -->


<!-- Accesss-code -->

<!-- Futaie afzonderlijk = hooghout versus brins de taillis =  -->
<!-- Dim carbonCoef As Double -->
<!-- carbonCoef = 0.47 -->


<!-- vef = exp(e.b1-(c130/pi()))^e.b2 + exp(e.b3+e.b4)*(c130/pi()) / htot^2+1 -->

<!-- vtotaer= varb * vef -->

<!-- vhatotaer = vtotaer * nha -->


<!-- Verschillende stappen: -->
<!-- 1) onderscheid hooghout (a = arbf90) en hakhout (a = arbt90): enkel om de correcte tabel te selecteren én ev. iets andere veldnamen -->

<!-- 2) select de velden uit de resp. tabel -->
<!-- - varb reeds berekend! ?? is dat stamvolume of stam + kroon? -->
<!-- - a.etg enkel voor futaie: komt verder niet voor -->
<!-- - a.etat: ook enkel bij futaie: enkel bepaalde codes (wellicht enkel levende) -->
<!-- - htot in meter voor futaie; NA voor taillis -->
<!-- - C130 obv C150 wellicht -->

<!-- 3) Estimer la hauteur: obv tabel "EqnHtBiom" én veld "eq_ht"  -->

<!-- 4) Estime un volume pour les arbres dont 20<circ<22 et ceratins (certifieer) autres arbres -->
<!-- - varb = 1/3*(htot*(cir/100)^2) / (4*pi()) where varb is null or varb=0 -->
<!-- REDEN: bij lage omtrekken is volume soms 0 obv Dagnelie => dan formule van kegel (?) -->
<!-- MAAR dan moet het stukje < 7cm ervan afgetrokken worden -->
<!-- h22 = calc_h22(cir, htot, c90, c10, c0, eq_cir)   // hoogte bij omtrek 22 -->
<!-- vol_bout = (1/3 * ((0.22^2) / (4*pi())) * (htot - h22)) where h22>0 -->
<!-- vha = (varb-vol_bout)*nha where vha is null or vha=0 -->

<!-- 5) volume de souche - NAGEVRAAGD bij Sébastien: onderst 10 cm van elke boom cfr Dagnelie -->
<!-- c0, c10, c90: resp. obv EqnC0Biom, EqnC10Biom, EqnCrBiom  -->
<!-- - EqnC10Biom & c10 = (e.b0 + e.b1 * c130 + e.b2 * c130^2 + e.b3 * c130^3 + e.b4 * htot + e.b5 * c130^2 * htot) where htot is not null -->
<!-- - EqnC0Biom & c0 = ((e.b0 + e.b1 / c10 + e.b2 / c10^2) * c10) where c10 is not null -->
<!-- - EqnCrBiom " pc=90 en c90 = ((e.b0 + e.b1 / c10 + e.b2 / c10^2) * c10) where c10 is not null -->


<!-- 5) Volume bout de tige: volume van de stam < 7 cm -->
<!-- Enkel gebruikt om volume te schatten van bomen met omtrek tss 20<cir<22 -->


<!-- 6) Adapter c150/c130 si c150 > 230 cm (volume Varb déjà calculé, c'est pour VEF qu'on limite à cir=230 car hors du domaine de validité) -->

<!-- 7) Volume total:  -->
<!-- VEF obv c130 en htot -->
<!-- vtotaer= varb * vef -->

<!-- 8) Biomasse aerienne sans souche et Biomasse aerienne avec souche  (stomp) -->
<!-- agb = vtotaer * e.mean_wd   // a < abovegroubnd, bovengronds -->
<!-- agbtot = (vtotaer+vol_souche) * e.mean_wd -->

<!-- 9) Biomasse souterraine -->
<!-- bgb = agbtot * bef2  // b < belowground, ondergronds -->
<!-- (= R-factor van VMM) -->

<!-- 10) Biomasse totale -->
<!-- biomtot = agbtot (mét stumps) + bgb  -->

<!-- 11) omrekening naar carbon mbv carbonfactor van 0.47 (ipv 0.5 bij VMM) -->


### Koppelen van boomsoortafhankelijke parameters

```{r koppelen_BEF_methode4, results = 'hide'}
colnames(trees_living)
colnames(BiomassFactors4_FRL)

BiomassFactors4_FRL_ <- BiomassFactors4_FRL %>% 
  dplyr::select(IDTreeSp, ESS_D, ESS_D_Latin, efor, NumEquation, R_FRL, eq_ht, eq_cir, eq_vef, eq_wd, WD_FRL)

trees_living4 <- trees_living %>% 
  left_join(BiomassFactors4_FRL_, by = c("IDTreeSp")) %>% 
  mutate(htot=HeightForVolCalc,
         d130=Diameter_cm,
         c130=Perimeter_cm, 
         FC = 0.5)   # 0.47 in access-txt van Sébastien, maar 0.5 algemener aanvaard (ook cfr VMM LULUCF rapportage 2021)

trees_living4 %>% filter(is.na(eq_vef)) %>% nrow()
``` 

### Conversie omtrek op 1,3m naar omtrek op 1,5m

Wallonië rekent bij bepaalde stappen in de berekening met c150 ipv c130. We maken hiertoe een extra attribuut c150 voor alle records.

```{r c130_naar_c150, results = 'hide', fig.show='hide'}
trees_living4 <- trees_living4 %>% 
  left_join(convC130, by = c("IDTreeSp", "NameNl")) %>% 
  mutate(c150 = (c130-A)/B) %>% 
  dplyr::select(-A,-B)

head(trees_living4[, c("c130", "c150")])

g <- ggplot(trees_living4, aes(x = c130, y = c150)) + geom_point () + geom_abline()
g

trees_living4 %>% filter(is.na(c150)) %>% nrow()

```

```{r check_c150_c130, results = 'hide', fig.show='hide'}
check1 <- trees_living4 %>% 
  mutate(verschil_c130c150 = c130-c150) 
g <- ggplot(check1, aes(x = c150, y = verschil_c130c150)) + geom_point (aes=(color = "SpeciesGroup"))
g


check <- trees_living4 %>% 
  mutate(verschil_c130c150 = c130-c150) %>% 
  filter(verschil_c130c150 < 0)
g <- ggplot(check, aes(x = c150, y = verschil_c130c150)) + geom_point ()
g

check_populier <- check %>% 
  filter(NameNl %in% c("Ratelpopulier", "Populier"))
g <- ggplot(check_populier, aes(x = c150, y = verschil_c130c150)) + geom_point ()
g

100*(nrow(trees_living4) - nrow(check))/nrow(trees_living4)
# ca 3% waarbij c130 > c150 ??
# slechts 1% verschil groter dan 0.1 cm

table(check$NameNl)
# enkel populier en 
table(check$Periode)
min(check$verschil_c130c150)
# -0.439697
max(check$c130)
# [1] 37.899
max(check$c150)
# [1] 38

```



### Schatting volume kleine bomen (20<c150<22)

Concreet: alle bomen waarbij volume berekend met de tarieven van Dagnelie gelijk aan 0 is (sommige daarvan hebben een omtrek > 22 cm)

Deze volumes blijken zo goed als verwaarloosbaar bij de berekening van de carbon uptake factor.

Volgende redenering wordt gevolgd:

- omtrek < 23 cm => volume cilinder met omtrek =  c130 (+/- aftop-omtrek) en hoogte = 1.3m
- omtrek >= 23 cm => volume afgeknotte kegel met hoogte bij aftopdiameter (h22: geschat obv diameter/hoogte-verhouding van de boom) 

<!-- (c)Anja: de berekening van h22 vond ik niet terug in de tarieven van Dagnelie (toch niet in versie van '69,, die van '85 heb ik niet). -->
<!-- Als we dat exact zoals wallonië willen doen, moeten ze ons ook die formules dan maar doorgeven.  -->
<!-- Maar lijkt me de moeite niet, omdat het zo goed als geen effect heeft op resultaat. -->

Creatie van extra attributen:

    * Volume_cilinder
    * Volume_kegel
    * htot_h22 (hulpvariabele voor berekening top kegel)
    * Volume_top_kegel
    * Volume_afgeknot

Afhankelijk van de situatie wordt vervolgens Volume_m3 ingevuld door Volume_m3 of een van de nieuw berekende values voor bomen met volume 0 en kleine omtrekken.

```{r volume_cilinder_afgeknotte_kegel}
# (1) c130 < 23 cm => cilinder: hoogte = 1.3m en omtrek = c130 => volume = pi*d130^2*htot/4

# (2) c13 >= 23 cm => afgeknotte kegel met basis = c130, top = 22 cm en hoogte = htot-h22
# waarbij h22 = c130*verh_h_c  (gemiddelde verhouding htot tov c130)

check <- trees_living4 %>% 
  filter(is.na(htot)) %>% 
  filter(Volume_m3 == 0)
# degene zonder hoogte én volume = 0, worden berekend als cilinder met hoogte 1.3m (geen htot nodig)

trees_living5 <- trees_living4 %>%
  # behouden van origineel volume zonder correctie (cfr repo v4), zoals ook in analysedb (tbl0,tbl10,tbl3)
    mutate(StemVolume_m3_v4 = Volume_m3) %>% 
  # cilinder met hoogte = 1.3m
    mutate(Volume_cilinder = ifelse(Volume_m3 == 0 & c130 < 23, (pi*d130^2*1.3/4)/10000, 0),
  # kegel                          
         Volume_kegel = ifelse(Volume_m3 == 0 & c130 >= 23, 1/3*(htot*(c130/100)^2) / (4*pi) , 0),
  # top kegel
         htot_h22 = c130/(htot*22),   # htot - h22 
         Volume_top_kegel = ifelse(Volume_m3 == 0 & c130 >= 23, 1/3 * ((0.22^2) / (4*pi) * (htot_h22)), 0), 
  # afgeknotte kegel
         Volume_afgeknot = ifelse(Volume_m3 == 0 & c130 >= 23, Volume_kegel - Volume_top_kegel, 0)
          ) %>% 
   # volume totaal aangepast
    mutate(Volume_m3 = ifelse(Volume_m3 == 0 & c130 >= 23, Volume_afgeknot, 
                              ifelse (Volume_m3 == 0 & c130 < 23, Volume_cilinder, Volume_m3))
          ) 

# %>%
#   select(IDPlots, IDSegments, Periode, ID, IDTreeSp, NameNl, d130, c130, c150, htot, StatusTreeCode, Coppice_IndividualCode, IntactTreeCode, Volume_m3, Volume_kegel, Volume_top_kegel, Volume_afgeknot,  htot_h22, Volume_cilinder, StemVolume_m3_v4) 
# %>% 
#    select(IDPlots, IDSegments, Periode, ID, IDTreeSp, NameNl, d130, c130, c150, htot, StatusTreeCode, Coppice_IndividualCode, IntactTreeCode, Volume_m3, StemVolume_m3_v4)

# trees_living5_t <- trees_living5 %>% 
#   filter (c130 >= 23 & Volume_afgeknot != 0)

```

```{r volume_kegel_Wall}
# varb = 1/3*(htot*(cir/100)^2) / (4*pi()) where varb is null or varb=0
```

```{r volume_top_kegel_Wall}
# vol_bout ervan aftrekken = volume kegel boven h22 (hoogte bij omtrek 22)

# vol_bout = (1/3 * ((0.22^2) / (4*pi) * (htot - h22)) where h22>0
# h22 halen uit dagnelie: wat is hoogte 

# h22 = calc_h22(cir, htot, c90, c10, c0, eq_cir)
    # eq_cir: van 1 tot 12, cfr tarieven
    # 
    # we hebben dus alle info, behalve de functie calc_h22 met input
    # c150
    # htot,
    # c90, c10, c0
    # welk tarief gebruiken (eq_cir) (1 tem 12)

# ! obv tabellen Dagnelie gebaseerd op C150 (cir Wallonië = C150)
# terwijl wij met C130 werken
#

# schatting van h22

```


```{r volume_kleine_bomen_Wall}
# vha = (varb-vol_bout)*nha

```


### Schatting ontbrekende hoogtes 

Op dit moment gebruiken we d-h-curves van Wallonië om ontbrekende hoogtes in te schatten (voornamelijk hakhout).

Op termijn kunnen we zelf curves aanmaken (in Inventory Analist, software van FieldMap). 


```{r missing_height, results = 'hide'}
trees_living5_no_height <- trees_living5 %>% 
  filter(is.na(htot))
table(trees_living5_no_height$Coppice_IndividualCode)  
 # 10    20 
 #38     12928

# htot=1.5 + (a / (1 + 1/(b * cir^c)) where p.htot is null or p.htot=0
trees_living5 <- trees_living5 %>% 
  left_join(EqnHtBiom, by = c("eq_ht" = "id")) %>% 
  mutate(htot = ifelse(is.na(htot), 1.5 + (a / (1 + 1/(b * c150^c))), htot)) %>% 
  dplyr::select(-a, -b, -c)

trees_living5 %>% filter(is.na(htot)) %>% nrow()
max(trees_living5$htot)
max(trees_living5$HeightForVolCalc, na.rm = T)
min(trees_living5$htot)
```
 

### Berekening VEF 

De Volume Expansion Factor (VEF) is afhankelijk van diameter, hoogte en boomsoort (Bron: Longuetaud et al. (2013)).

Opdelen in stukjes :

    - omtrek > 230 (c150) ---> de VEF van 230 cm gebruiken
    
    - d150 nodig ---> opnieuw berekenen
    
    
```{r VEF_correctie_grote_c150, results = 'hide'}
# c150 > 230 cm ligt buiten geldigheid van VEF => de VEF van 230 cm gebruiken

grote_c150 <- trees_living5 %>% 
  filter(c150 > 230)
# 100* (nrow(grote_c150)/nrow(trees_living5))
# 1%

# d130 op max. instellen (d130 wordt gebruikt bij berekening van VEF)
# c130=(q.hv * 230 +q.iv)

trees_living5 <- trees_living5 %>% 
  left_join(convC130, by = c("IDTreeSp", "NameNl")) %>% 
  mutate(d130 = ifelse(c150>230, (A + B*230)/pi, d130)) %>% 
  dplyr::select(-A, -B)

t <- trees_living5 %>% 
  filter(c150 > 230)

head(t, 20)
# kleine verschillen zijn te wijten aan andere A en B voor verschillende soorten
```

```{r VEF, results = 'hide'}
# VEF obv c130 en htot
# vef = exp(e.b1-(c130/pi)^e.b2 + exp(e.b3+e.b4)*(c130/pi()) / htot^2+1;"
trees_living5 <- trees_living5 %>% 
  left_join(EqnVEFBiom, by = c("eq_vef" = "id")) %>% 
  mutate(VEF = exp(b1-d130)^b2 + exp(b3+b4)*d130/htot^2 + 1) %>% 
  dplyr::select(-b1, -b2, -b3, -b4)

trees_living5 %>% filter(is.na(VEF)) %>% nrow()


```


### Totaal bovengronds volume mbv VEF 

Om het totale bovengrondse volume te berekenen, wordt het stamvolume vermenigvuldigd met de net berekende, boomspecifieke VEF-factor van Longuetaud.

```{r bovengronds_totaal_volume, results = 'hide'}
# vtotaer= varb * vef

trees_living5 <- trees_living5 %>% 
  mutate(TotalVolume_m3 = VEF * Volume_m3)

check <- trees_living5 %>% 
  mutate(test = TotalVolume_m3/Volume_m3) %>% 
  dplyr::group_by(Periode) %>% 
  dplyr::summarize(test = mean(test, na.rm = T))
            
check       
# 1	1.372480			
# 2	1.397972		
# gemiddeld 1.37 à 1.40 om van stamvolume naar totaal volume te gaan

# @Anja : ik zie niet hoe dit volume kan anders zijn tov v4? (tenzij kleine validatiewijzigingen)
  
# 1	1.375674			
# 2	1.399248
# 3	1.435864	
```


### Volume van de stomp (souche)

Het bovengrondse volume wordt verder aangevuld met het volume van de stomp.

De stomp is de onderste 10 cm van elke boom, en wordt berekend als het volume van een cilinder met

- hoogte = 10 cm
- omtrek = omtrek onderaan de stam (c0)
- c10 wordt afgeleid van c130
- c0 wordt afgeleid van c10

<!-- (resp. obv EqnC0Biom, EqnC10Biom, EqnCrBiom) -->

<!-- - EqnC10Biom & c10 = (e.b0 + e.b1 * c130 + e.b2 * c130^2 + e.b3 * c130^3 + e.b4 * htot + e.b5 * c130^2 * htot) where htot is not null -->
<!-- - EqnC0Biom & c0 = ((e.b0 + e.b1 / c10 + e.b2 / c10^2) * c10) where c10 is not null -->
<!-- - EqnCrBiom " pc=90 en c90 = ((e.b0 + e.b1 / c10 + e.b2 / c10^2) * c10) where c10 is not null -->


```{r volume_de_souche, results = 'hide'}
# c10
        # EqnC10Biom as e on (p.eq_cir=e.id) set 
        # c10 = b0 + b1 * c130 + b2 * c130^2 + b3 * c130^3 + b4 * htot + b5 * c130^2 * htot
        #        where htot is not null
trees_living5 %>% filter(htot == 0 | is.na(htot)) %>% nrow()

trees_living5 <- trees_living5 %>% 
  left_join(EqnC10Biom, by = c("eq_cir"= "ID")) %>% 
  mutate(c10 = b0 + b1 * c130 + b2 * c130^2 + b3 * c130^3 + b4 * htot + b5 * c130^2 * htot) %>% 
  dplyr::select(-b0, -b1, -b2, -b3, -b4, -b5)

# c0
      # EqnC0Biom as e on (p.eq_cir=e.id) set
      # c0 = (b0 + b1 / c10 + b2 / c10^2) * c10
      # where c10 is not null
trees_living5  %>% filter(c10 == 0 | is.na(c10)) %>% nrow()

trees_living5 <- trees_living5 %>% 
  left_join(EqnC0Biom, by = c("eq_cir"= "id")) %>% 
  mutate(c0 = (b0 + b1 / c10 + b2 / c10^2) * c10) %>% 
  dplyr::select(-b0, -b1, -b2)

# c90
    # EqnCrBiom as e on (p.eq_cir=e.code and e.pc=90) set 
    # c90 = b0 + b1 / c10 + b2 / c10^2) * c10 
    # where c10 is not null
trees_living5 <- trees_living5 %>% 
  left_join(EqnCrBiom, by = c("eq_cir"= "id")) %>% 
  mutate(c90 = (b0 + b1 / c10 + b2 / c10^2) * c10) %>% 
  dplyr::select(-b0, -b1, -b2)


# volume souche

# vol_souche = 0.1 * (c0/100)^2 / (4*pi)  
# volume cilinder met straal = c0 en hoogte = 10 cm
# c0 wordt afgeleid van c10 from Dagnelie taper models (2013). These "taper" models requires as variable the circumference located at 10% of the beginning of the stem: c10
# C10 is itself estimated from C130

trees_living5 <- trees_living5 %>% 
  mutate(VolumeStump_m3 = 0.1 * (c0/100)^2 / (4*pi),
         StemVolume_m3 = Volume_m3) # stamvolume cfr  FRL met correctie voor dunne boompjes

trees_living5 %>% filter(VolumeStump_m3 == 0 | is.na(VolumeStump_m3)) %>% nrow()

check <- trees_living5 %>% 
  dplyr::select(IDPlots, NameNl, ID, Periode, d130, c130, c0, c10, c90, htot, Volume_m3, VolumeStump_m3) %>% 
  mutate(verh_stump_stam_perc = round(100*VolumeStump_m3/Volume_m3, 2))

head(check, 10)

check2 <- check %>% 
  filter(Volume_m3 != 0) %>% 
  group_by(NameNl) %>% 
  summarize(verh_stump_stam_perc = mean(verh_stump_stam_perc)) %>% 
  ungroup()

head(check2, 10)

```


### Totale biomassa (ondergronds + bovengrondse)

Om tot totaal koolstofgehalte (C/ha) te komen, worden volgende stappen doorlopen:

1) **bovengrondse biomassa** wordt afgeleid van het totale bovengrondse **volume** (mét stomp), gebruik makend van een soort-specifieke wood density (ton/m³).

2) Vervolgens wordt de **ondergrondse** biomassa berekend door de bovengrondse biomassa te vermenigvuldigen met een soort-specifieke R-factor.

#### Bovengrondse biomassa

Van volume naar biomassa met behulp van wood density (WD).

```{r bovengrondse_biomassa, results = 'hide'}
# 8) Biomasse aerienne sans souche et Biomasse aerienne avec souche  (stomp)
# 
# agb = vtotaer * e.mean_wd   // a < aboveground, bovengronds
# agbtot = (vtotaer+vol_souche) * e.mean_wd

names(trees_living5)

trees_living5 <- trees_living5 %>% 
  mutate(R = R_FRL,
         WD= WD_FRL,
         FC = 0.5) %>% 
  mutate(TotalAboveGrBiomass_t = (TotalVolume_m3 + VolumeStump_m3)*WD)

```


#### Ondergrondse biomassa 

De ondergrondse biomassa wordt afgeleid van de bovengrondse mbv een soort-specifieke R-factor.

```{r ondergrondse_biomassa, results = 'hide'}
trees_living5 <- trees_living5 %>% 
  mutate(TotalBelowGrBiomass_t = (TotalVolume_m3 + VolumeStump_m3)*WD*R) 

```


#### Totale biomassa totaal

```{r totale_biomassa, results = 'hide'}
trees_living5 <- trees_living5 %>% 
  mutate(TotalBiomass_t = (TotalVolume_m3 + VolumeStump_m3)*WD*(1+R)) 

```


### Totaal koolstofgehalte (ondergronds + bovengronds) 

Tenslotte wordt de biomassa omgezet in **koolstof** gebruik makend van een carbon conversie factor (FC). 
De default IPCC conversion factor CC heeft een waarde van 0.5 (Eggleston et al., 2006, equation 8). 
Dit is conform de methodology NFAP.

```{r total_carbon, results = 'hide'}
trees_living5 <- trees_living5 %>% 
  mutate(TotalCarbon_t = (TotalVolume_m3 + VolumeStump_m3)*WD*FC*(1+R) 
         ) 

```


## Omzetting naar plotniveau

Vertrekkende van *tbl0Boom* => bosoppervlakte van de bosplot in rekening brengen


```{r plotniveau, results = 'hide'}
colnames(trees_living5)
analyseSet <- trees_living5 %>%
  dplyr::group_by(IDPlots, Periode, PlotWeight, DateDendro, REEKS) %>%   
  dplyr::summarise(
            CheckVolumeTotaal = sum(Volume_m3*Fext_Ha, na.rm = TRUE),    
            StemVolume_m3_ha = sum(StemVolume_m3*Fext_Ha, na.rm = TRUE), # met correctie voor dunne boompjes met volume Dagnelie = 0 (zie chunck "volume_cilinder_afgeknotte_kegel") 
            StemVolume_m3_ha_v4 = sum(StemVolume_m3_v4*Fext_Ha, na.rm = TRUE),  # cfr Dagnelie/Quataert (repo v4)
            VolumeStump_m3_ha = sum(VolumeStump_m3*Fext_Ha, na.rm = TRUE),
            TotalVolumeVEF_m3_ha = sum(TotalVolume_m3*Fext_Ha, na.rm = TRUE),
            Biomass_t_ha = sum(TotalBiomass_t*Fext_Ha, na.rm = TRUE),
            Carbon_t_ha = sum(TotalCarbon_t*Fext_Ha, na.rm = TRUE),
            # test = StemVolume_m3_ha - StemVolume_m3_ha_v4,
            # test_proc = 100*test /StemVolume_m3_ha_v4
            ) %>%
  dplyr::ungroup() %>%
  dplyr::rename(Year = DateDendro,
         Weight = PlotWeight, Reeks = REEKS)

# summary(trees_living5)
```


Aan de lijst van plots mét bomen moeten de plots zonder bomen (volume = 0) toegevoegd  worden, die behoren tot productief bos (geen open ruimtes).
Dit zijn kapvlaktes of bestanden met enkel verjonging (bomen met diameter < 7 cm).

Deze plots leiden we af van tbl10Boomsoorten, cfr advies A3844 voor berekening van totaal volume per boomsoort.

Nadeel is dat de plots zonder enige verjonging ontbreken (want geen boomsoort vermeld).

Voordeel is dat dit het nauwste aansluit bij de resultaten van het advies A.3844.

We maken hierbij gebruik van  

- v3_Volume_ha en v2_BasalArea_ha => volume en grondvlak = 0 
- (Landuse: gecheckt en in tbl10 zitten geen plots waarvan Landuse = "open ruimte" of "geen bos")

Alternatieven zijn:

- enkel werken met plots waar bomen met DBH > 7 cm voorkomen => lagere uptake factoren (zie script "GEG_LULUCF_MeanCarbonUptake_Methodes1234TreeLevel_enkel_plots_met_bomen.Rmd")
- ook plots zonder verjonging toevoegen => hogere uptake factoren (zie script "GEG_LULUCF_MeanCarbonUptake_Methodes1234TreeLevel_alle_bosplots.Rmd")

<br>

<!-- **ALTERNATIEF ** -->

<!-- We zouden de plots ook kunnen afleiden van tbl3BestandskaraktKwant.  -->
<!-- Daar zitten dan ook kapvlaktes zonder enige verjonging in (51 plots).  -->
<!-- Nadeel is dat we dan afwijken van advies A3844. -->
<!-- -->
<!-- Het rare is dat dit totaal volume meer afwijkt van staande houtvoorrad: 210.7 en 272.1 (obv tbl3) versus 216.5 en 273.5 op website en 219.6 en  274.7 obv script Toon (Tijls xls) en 216.3 en 274,2 als we ons baseren op tbl10 -->

<!-- We maken hierbij gebruik van de velden  -->

<!-- - v11_Volume_ha => volume = 0  -->
<!-- - Landuse => BOS -->


<!-- (veld 'Landuse' komt overeen met veld 'Standtype', op één record na: 348125, periode 2: Standtype = niet van toepassing, Landuse = BOS) -->
<!-- Bij berekening houtvoorraad worden niet-bos segmenten verwijderd door te filteren -->
<!-- op StandType !="open ruimte binnen bos" of analyseSet$StandType !="niet van toepassing" -->

Landuse V5 : in alle tabellen (behalve MeetnetDetails en invb) komen enkel bossegmenten voor. Met bossegmenten wordt wel bedoeld : fase2 bossegmenten = foa én forest.
Onder foa zitten ook bv permanent boomvrije oppervlaktes. Dus om de geest van het advies te volgen moeten we deze nog wegfilteren, en enkel de BOS-open plekken meenemen, maw filteren op fase3_forest = "forest".
*Zie Inlezen_Meetproces.Rmd : ifelse(fase3_forest == 'BOS - kaalkap', 'forest',...*

```{r lg_v5}
tbl_boomsoort_foa <- tbl_boomsoort %>%
    left_join(tbl_RecordVBI23, by = c("IDPlots", "IDSegments", "Periode")) %>%
    left_join(tbl_RecordVBI1, by =  c(c("IDPlots" = "idplots"), c("Periode" = "periode"))) %>%
    dplyr::select(colnames(tbl_boomsoort), Landuse, landuse) %>%
    filter(Landuse == 'foa' | landuse == 'open plek') #0 want enkel bossegmenten in de tabel

tbl_boomsoort_forest <- tbl_boomsoort %>%
    left_join(tbl_RecordVBI23, by = c("IDPlots", "IDSegments", "Periode")) %>%
    left_join(tbl_RecordVBI1, by =  c(c("IDPlots" = "idplots"), c("Periode" = "periode"))) %>%
    dplyr::select(colnames(tbl_boomsoort), Landuse, landuse) %>%
    filter(Landuse == 'forest' | landuse %in% c('bos', 'bos - kapvlakte')) #25597

nrow(tbl_boomsoort) - nrow(tbl_boomsoort_forest)
```



```{r bosplots_zonder_volume_obvtbl10, results='hide'}
# we hebben info op plotniveau nodig, niet op segment niveau!
tbl_boomsoort_notNA <- tbl_boomsoort %>%
    left_join(invb %>% dplyr::select(IDPlots = PLOTNR, REEKS), by = "IDPlots") %>%
  filter(!is.na(PlotWeight),
         !is.na(SegmentWeight),
         !is.na(DateDendro),
         !is.na(SpeciesGroup),
         !is.na(v3_Volume_ha),
         !is.na(StatusTreeCode))

nrow(tbl_boomsoort) - nrow(tbl_boomsoort_notNA)
```

NA's : niet toegankelijk voor bosbouwopname. Soms wel al A2 opgemeten.

```{r lg2}

tbl_boomsoort_NA <- tbl_boomsoort %>%
    dplyr::select(IDPlots, IDSegments, Periode, PlotWeight, SegmentWeight, DateDendro, SpeciesGroup, v3_Volume_ha, StatusTreeCode) %>%
  filter_all(any_vars(is.na(.)))

nrow(tbl_boomsoort_NA)

nrow(tbl_boomsoort_NA) == (nrow(tbl_boomsoort) - nrow(tbl_boomsoort_notNA))
```

```{r plots_zonder_volume_obvtbl10, results='hide'}

tbl_boomsoort_notNA %>% 
    left_join(tbl_NA, by = c("IDPlots", "Periode")) %>% 
    filter(!is.na(NrOfTreesWithNA) & NrOfTreesWithNA > 0) %>%  
    nrow()
# plots met missing values volledig verwijderd - OK

plots_volume_tbl10 <- tbl_boomsoort_notNA %>% 
  dplyr::group_by(IDPlots, Periode, PlotWeight) %>% 
  dplyr::summarize(aantal_segm = n(),
            v3_Volume_ha = sum(v3_Volume_ha*SegmentWeight, na.rm = TRUE),  
            v2_BasalArea_ha = sum(v2_BasalArea_ha*SegmentWeight, na.rm = TRUE),  
            DateDendro = first(DateDendro),
            Reeks = first(REEKS)) %>% 
  dplyr::ungroup() 

plots_volume0_tbl10 <- plots_volume_tbl10 %>% 
  filter(v3_Volume_ha == 0 & v2_BasalArea_ha == 0)  

nrow(plots_volume0_tbl10)
table(plots_volume0_tbl10$Periode) 

```

```{r add_bosplots_without_volume_obvtbl10, results='hide'}
# plots_0: 141 plots/periode
colnames(analyseSet);colnames(plots_volume0_tbl10)

analyseSet_0_biomassa <- plots_volume0_tbl10 %>%
  dplyr::select(-aantal_segm, -v3_Volume_ha, -v2_BasalArea_ha) %>%
  dplyr::rename(Weight = PlotWeight,
         Year = DateDendro) %>%
  mutate(CheckVolumeTotaal = 0,
         StemVolume_m3_ha = 0,
         StemVolume_m3_ha_v4 = 0,
         VolumeStump_m3_ha = 0,
         TotalVolumeVEF_m3_ha = 0,
         Biomass_t_ha = 0,
         Carbon_t_ha = 0
          )

analyseSet2 <- rbind(analyseSet, analyseSet_0_biomassa)
nrow(analyseSet) + nrow(analyseSet_0_biomassa) - nrow(analyseSet2)

analyseSet <- analyseSet2

```

# Per Species

toevoeging v5 om ook volume per boomsoort te berekenen op een manier die overeenstemt met de LULUCF rapportering.

- eerst 0 toevoegen voor plots waar de soort niet aanwezig is om gemiddelden te kunnen berekenen
- idem voor de plots zonder biomassa: 0'en toevoegen voor de plots zonder bomen voor alle boomsoorten

```{r AnalyseSet_Species, include=FALSE}
colnames(trees_living5)
colnames(analyseSet_0_biomassa)

nrow(trees_living5 %>% filter(is.na(Fext_Ha)))

trees_living6 <- trees_living5 %>%
      plyr::rbind.fill(analyseSet_0_biomassa) %>% # met of zonder plots zonder gemeten bomen (wel in tbl0Boomsoorten)
      dplyr::select(IDPlots, Fext_Ha, PlotWeight, REEKS, DateDendro, StemVolume_m3_v4, StemVolume_m3, Periode, IDSpeciesGroup, SpeciesGroup) #volume is per ha, zonder extensiefactor toegepast, dus voor verondersteld plotw en segmw 1

            # StemVolume_m3_v4 = cfr. Dagnelie/Quataert < tbl0Boom (Volume_m3)
            # StemVolume_m3 = cfr Dagnelie, maar correctie van volume dunne boompjes met volume = 0

nrow(analyseSet_0_biomassa) == nrow(trees_living6 %>% filter(is.na(StemVolume_m3)))
nrow(analyseSet_0_biomassa) == nrow(trees_living6 %>% filter(is.na(StemVolume_m3_v4)))

trees_living6$StemVolume_m3[which(is.na(trees_living6$StemVolume_m3))] <- 0
trees_living6$Volume_m3[which(is.na(trees_living6$StemVolume_m3_v4))] <- 0

trees_living6 <- trees_living6 %>%
    mutate(StemVolume_m3_ha = ifelse(is.na(Fext_Ha), 0, StemVolume_m3 * Fext_Ha),
           StemVolume_m3_ha_v4 = ifelse(is.na(Fext_Ha), 0, StemVolume_m3_v4 * Fext_Ha)
           ) # want verderop nemen we Fext niet mee 



# eerst SpeciesGroup vereenvoudigen
n_trees <- 20

top_n_trees <- trees_living6 %>%
  dplyr::group_by(SpeciesGroup) %>% 
  filter(Periode == 2) %>% # de belangrijkste boomsoorten van de recente afgewerkte metingen.
  dplyr::summarise(volume_sum = sum(StemVolume_m3_ha)) %>%
  ungroup() %>%
  arrange(desc(volume_sum)) %>%
  top_n(n_trees, volume_sum) %>%
  mutate(top_n = T) 

# onderscheid loofhout en naaldhout; 'ANDERE SOORT' veronderstellen we loofhout 
naaldhout_loofhout <- tbl_boomsoort_notNA %>%
  distinct(SpeciesGroup, LH_NH) %>%
  mutate(LH_NH = ifelse(SpeciesGroup == "_ANDERE SOORT", "LH", as.character(LH_NH)))

trees_living6 <- trees_living6 %>%
   left_join(top_n_trees, by = "SpeciesGroup") %>%
   left_join(naaldhout_loofhout, by = "SpeciesGroup") %>%
   data.frame() %>%
   mutate(SpeciesGroup = ifelse(!is.na(top_n) & top_n, SpeciesGroup, LH_NH)) 

table(trees_living6$LH_NH,trees_living6$SpeciesGroup)


# groeperen per soort, plot en periode om aantal records te beperken
trees_living6 <- trees_living6 %>%
    dplyr::group_by(IDPlots, PlotWeight, DateDendro, REEKS, Periode, SpeciesGroup) %>%
    dplyr::summarise(StemVolume_m3_ha= sum(StemVolume_m3_ha)) %>%
    dplyr::ungroup()

# nullen voor afwezige boomsoorten per plot zodat we een correct gemiddelde kunnen berekenen over alle plots heen
trees_living6_wide <- trees_living6 %>%
      spread(SpeciesGroup, StemVolume_m3_ha, fill = 0) 

trees_living7 <- trees_living6_wide %>%
  gather(-IDPlots, -Periode, -PlotWeight
         , -DateDendro
         , -REEKS
         , key ="SpeciesGroup", value = "StemVolume_m3_ha")
  # arrange(IDPlots, Periode) 

colnames(trees_living7)

      
```


```{r AnalyseSet_Species2, include=FALSE}
nrow(trees_living7 %>% filter(is.na(StemVolume_m3_ha)))

trees_living7 <- trees_living7 %>%
    mutate(StemVolume_m3_ha = ifelse(is.na(StemVolume_m3_ha), 0, StemVolume_m3_ha))

analyseSetSpeciesGr <- trees_living7 %>%
  dplyr::group_by(IDPlots, Periode, PlotWeight, DateDendro, REEKS
                  , SpeciesGroup) %>%   
  dplyr::summarise(StemVolume_m3_ha = sum(StemVolume_m3_ha, na.rm = T)) %>% # maar alle NA's zijn 0 gemaakt 
  dplyr::ungroup() %>%
  dplyr::rename(Year = DateDendro,
         Weight = PlotWeight, Reeks = REEKS) %>%
    mutate(SpeciesGroup = factor(as.character(SpeciesGroup)))

```


# Resultaat

<!-- Tot hier is er per boom volumes etc berekend, ongeacht de periode of reeks waarin de opname is gebeurd. -->
<!-- Voor rapportering kunnen we een voortschrijdend gemiddelde gaan berekenen, over de plots die gedurende de laatste tien jaar zijn gemeten. Een aantal reeksen van die plots zijn 10 jaar eerder gemeten, een voorlopig nog groter aantal is gemiddeld 15 jaar geleden gemeten. -->

We filteren op reeks eerder dan op Year omdat Year de eigenlijke datum van BB opname is. Om alle plots van de reeks mee te hebben (ook deze die pas na nieuwjaar zijn opgemeten) is dat beter.

```{r KiesPeriode}

afgewerkt <- c(0) # 10 reeksen VBI1 en 10 reeksen VBI2
afgewerkt <- c(1,2) #20% van VBI3 is afgewerkt
source(here::here("scripts/VBI3_constanten.R"))

```

## analyseset met data van 10 opgemeten reeksen 

```{r analyseSet_GekozenPeriode}

analyseSet <- get_last_20y(Data = analyseSet2, Afgewerkt = afgewerkt)
table(analyseSet$Periode);table(analyseSet$VBI)

```



## Overzicht

```{r statistics_per_periode, results = 'hide'}

colnames(analyseSet)
variables_for_statistics <- c("StemVolume_m3_ha", "StemVolume_m3_ha_v4", "VolumeStump_m3_ha", "TotalVolumeVEF_m3_ha", "Biomass_t_ha", "Carbon_t_ha")

p <- analyseSet %>% dplyr::select(Periode) %>% unique() %>% arrange(Periode)

t1 <- as.numeric(p[1,1])
t2 <- as.numeric(p[2,1])

p1 <- My.WgtParEstimation(analyseSet,VariableName = variables_for_statistics,Periode= t1)
p2 <- My.WgtParEstimation(analyseSet,VariableName = variables_for_statistics,Periode= t2)

Resultaat <- rbind (p1, p2)
#colnames(Resultaat)
# Resultaat[10:13] <- round(Resultaat[10:13],3)
Resultaat


vars <- c("periode", "minYear", "maxYear", "minReeks", "maxReeks")

Resultaat <- Resultaat %>%
    mutate_at(vars, factor)
# wegschrijven naar resultatendatabank
Resultaat <- Resultaat %>%
      mutate_at(c("minReeks", "maxReeks", "periode", "minYear", "maxYear"), factor)

```


```{r create_results_wide, results='hide'}
# van long naar wide
# dan aftrekken en delen door 16

Resultaat_wide <- Resultaat %>% 
  dplyr::select(variabele, periode, wgt.mean) %>% 
  spread(periode, wgt.mean, sep = "_") %>% 
  mutate(increase = `periode_2` - `periode_1`,
         increase_per_yr = round(increase/mtimelaps, 6), # mtimelaps 
         periode_1 = round(`periode_1`, 2),
         periode_2 = round(`periode_2`, 2),
         increase = round(increase, 2)) 

```


```{r table_results}
Resultaat_wide %>% 
  dplyr::select(-increase) %>% 
  dplyr::rename("Jaarlijkse toename" = increase_per_yr,
         # "carbon increase (tC/ha)" = increase,
         "Periode 1" = periode_1,
         "Periode 2"= periode_2) %>% 
  DT::datatable(filter = "none", selection = "none", rownames = FALSE, 
                options = list(pageLength = 5, dom = 'tip'))

```

## Resultaten wegschrijven

De resultaten worden weggeschreven naar 

- de resultatendatabank 
- een csv-file: resultVolumeBiomassCarbonUptake_MethodeFRL_TreeLevel.csv

```{r resultatendb_periode1vs2_toestand}
# Toestand
My.ResultsToDatabase(dbHandle = dbResultaten_path
                        , tblName = "tblResultaten"
                        , results = Resultaat
                        , scriptName = "GEG_LULUCF_VolumeBiomassCarbon_MethodeFRL_TreeLevel.Rmd"
                        , type="D"
                        , description = paste0("Volume (m3/ha), biomassa en koolstofgehalte (ton/ha) - cfr FRL & INBO-advies A.4103 (meth. 4b)", reeksinfo20 ) # reeksinfo : de 'nette', 'theoretische' periode itt minYear, maxYear : berekend obv terreinwerk. Is correct zo.
                       , forestedge = "met randplots"
                       , datasource = paste(str_extract(dbAnalyseData ,"VBI_Analysedatabank.+"), "&", str_extract(dbMeetproces ,"VBI_Meetproces.+"))
                       , datasource_hash = as.character(md5(dbAnalyseData_path))
                       , request_from = "VMM - LULUCF"
                       , run_by = run
                       , scriptLocation = "3DendroKwant")


```


```{r resultatendb_evolutie}
# My.ResultsToDatabase: enkel bij analyseTypoe = M, wordt er weggeschreven naar tblResultaten_Verschil
# Anders steeds naar tblResultaten_toestand

results_toename <- as.data.frame(Resultaat_wide) %>%
  dplyr::select(-periode_1, -periode_2, -increase) %>% 
  mutate(periode = NA
         , stratumNaam = NA
         , wgt.mean = increase_per_yr   #♀ as.numeric(as.character(increase_per_yr))
         , wgt.var = NA
         , minYear = factor(1997)
         , maxYear = factor(startVBI3 + max(afgewerkt) -1)
         , minReeks = factor(1)
         , maxReeks = factor(10)
         , nbObservaties = NA
         , strata = NA
         , llci = NA #as.numeric(as.character(llci))
         , ulci = NA #as.numeric(as.character(ulci))  
         ) %>%
  dplyr::select(variabele, periode, everything())

My.ResultsToDatabase(dbHandle = dbResultaten_path
                        , tblName = "tblResultaten"
                        , results = results_toename
                        , scriptName = "GEG_LULUCF_VolumeBiomassCarbon_MethodeFRL_TreeLevel.Rmd"
                        , type="D"
                       , description = paste0("Toename in volume (m3/ha/jr), biomassa en koolstof (ton/ha/jr) - cfr FRL & INBO-advies A.4103 (meth. 4b)", reeksinfo20)
                       , forestedge = "met randplots"
                       , datasource = dbAnalyseDataTxt
                       , datasource_hash = as.character(md5(dbAnalyseData_path))
                       , request_from = "VMM - LULUCF"
                       , run_by = run 
                       , scriptLocation = "3DendroKwant")
```

```{r export_to_csv_wide, include=FALSE}
write_excel_csv2(Resultaat_wide,here::here("Output/Tabellen_tmp/resultVolumeBiomassCarbonUptake_MethodeFRL_TreeLevel.csv"))
```




# Resultaat per boomsoort

```{r}
afgewerkt # check is ok?

analyseSet_top_n <- get_last_20y(Data = analyseSetSpeciesGr, Afgewerkt = afgewerkt) 

table(analyseSet_top_n$Periode);table(analyseSet_top_n$VBI)


```

```{r statistics_per_periode_bms, results = 'hide'}

variables_for_statistics <- c("StemVolume_m3_ha")

p <- analyseSet_top_n %>% dplyr::select(Periode) %>% unique() %>% arrange(Periode)


t1 <- as.numeric(p[1,1])
t2 <- as.numeric(p[2,1])

p1 <- My.WgtParEstimation(analyseSet_top_n
                            , VariableName = variables_for_statistics
                            , Periode= t1
                            , UseStrata = TRUE
                            , Strata = "SpeciesGroup"
                            )

p2 <- My.WgtParEstimation(analyseSet_top_n
                            , VariableName = variables_for_statistics
                            , Periode= t2
                            , UseStrata = TRUE
                            , Strata = "SpeciesGroup"
                            )

Resultaat_bms <- rbind (p1, p2)
#colnames(Resultaat)
# Resultaat[10:13] <- round(Resultaat[10:13],3)
Resultaat_bms

# Resultaat_bms <- Resultaat_bms %>%
#       mutate_at(.vars = vars, factor) 



```


```{r create_results_wide_bms, results='hide'}
# van long naar wide
# dan aftrekken en delen door 16

Resultaat_wide_bms <- Resultaat_bms %>% 
  dplyr::select(variabele, periode, wgt.mean, stratumNaam, strata) %>% 
  spread(periode, wgt.mean, sep = "_") %>% 
  mutate(increase = `periode_2` - `periode_1`,
         increase_per_yr = round(increase/mtimelaps, 6), # mtimelaps 
         periode_1 = round(`periode_1`, 2),
         periode_2 = round(`periode_2`, 2),
         increase = round(increase, 2))

Resultaat_wide_bms <- Resultaat_wide_bms %>%
      mutate_at(.vars = c("periode_1", "periode_2"), factor) 
```

## Resultaten wegschrijven - per boomsoort

```{r resultatendb_periode1vs2_toestand_bms}
# Toestand
My.ResultsToDatabase(dbHandle = dbResultaten_path
                      , tblName = "tblResultaten"
                      , results = Resultaat_bms
                      , scriptName = "GEG_LULUCF_VolumeBiomassCarbon_MethodeFRL_TreeLevel.Rmd"
                      , type="D"
                      , description = paste0("Volume (m3/ha) - cfr FRL & INBO-advies A.4103 (meth. 4b)", reeksinfo20, "  - top ", nrow(top_n_trees)," bms" )
                      , forestedge = "met randplots"
                      , datasource = dbAnalyseDataTxt
                      , datasource_hash = as.character(md5(dbAnalyseData_path))
                      , request_from = "VMM - LULUCF"
                      , run_by = run
                      , scriptLocation = "3DendroKwant"
                       )


```

## Totaal volume Vlaanderen - per boomsoort

```{r, include=FALSE}
#even als constante inladen, jaarlijks aan te vullen
bosopp1 <- bosopp %>% filter(periode == 1) %>% pull(gemiddelde) %>% unique()
bosopp2 <- bosopp %>% filter(periode == 2) %>% pull(gemiddelde) %>% unique()

bosopp %>% dplyr::select(periode, beschrijving,11:23)

bosopp_20 <- bosopp %>% 
      filter(periode == '-20' & str_detect(string = beschrijving, pattern = reeksinfo)) %>% 
      pull(gemiddelde)

bosopp_10 <- bosopp %>% 
      filter(periode == '-10' & str_detect(string = beschrijving, pattern = reeksinfo)) %>% 
      pull(gemiddelde)

bosopp1; bosopp_20;bosopp2; bosopp_10; 

# 100% vbi1
# afgewerkt % VBI2 en rest VBI1
# 100% VBI2
# afgewerkt % VBI3  en rest VBI2

```

We werken met de productieve bosoppervlakte cfr advies Westra (2019) : per bekeken dataset het aantal open ruimtes, behorende tot het bos (foa's) verrekenen om van totale bosoppervlakte naar productieve bosoppervlakte te gaan.


Voor v4 is dit niet nodig, daar is de productieve oppervlakte gelijk aan de bosoppervlakte (na review : weglaten van grote open heides VBI1).

```{r v4 productief bos, eval=FALSE, include=FALSE}

bosopp_productief <- tibble(
  periode = c(-10,-20), 
  Bosopp = c(bosopp1, bosopp2))

bosopp_productief <- bosopp_productief %>%
  mutate(opp_prd_bos = Bosopp, # vanaf Periode 3 hier onderscheid maken op basis van genoteerde landcategory
         prop_prd_bos = (opp_prd_bos/opp_V/100),
         se_bos_prod = (prop_prd_bos * (1-prop_prd_bos)/sample_size_vbi)^0.5 * opp_V) %>%
  select(periode, opp_prd_bos, se_bos_prod)
```


```{r v5 productief bos, include=FALSE}
bosopp_productief <- MeetnetDetails  %>%
      filter(fase2_forest == 'foa') %>% 
      dplyr::select(IDPlots = idplots, Periode = periode, Reeks = reeks, everything()) %>%
      get_last_20y() %>%
      mutate(bosopp = ifelse(max(afgewerkt) == 0 & Periode == -20, bosopp1
                       , ifelse(max(afgewerkt) == 0 & Periode == -10, bosopp2
                         , ifelse((Reeks > max(afgewerkt) & VBI == 1) |( Reeks <= max(afgewerkt) & VBI == 2), bosopp_20
                          , ifelse((Reeks <= max(afgewerkt) & VBI == 3) | Reeks > max(afgewerkt) & VBI == 2, bosopp_10, NA))) )) %>%
      dplyr::select(periode = Periode, bosopp) %>%
      dplyr::group_by(periode, bosopp) %>%
      dplyr::summarise(OpenRuimte = n()) %>%
      dplyr::ungroup() %>%
      mutate(opp_prd_bos = bosopp - 50 * OpenRuimte,
         prop_prd_bos = opp_prd_bos/opp_V,
         se_bos_prod = (prop_prd_bos * (1-prop_prd_bos)/sample_size_vbi)^0.5 * opp_V,
         perc = (opp_prd_bos/bosopp)*100) %>%
      dplyr::select(periode, bosopp, perc, opp_prd_bos, se_bos_prod)

bosopp_productief

```

@anja : als akkoord kan de code simpeler worden door gebruik te maken van de functie get_prod_bosopp_last20y (vermits dit toch jaarlijks zal moeten gebeuren)

```{r}
bosopp_productief <- get_prod_bosopp_last20y(connectieResultaten = connectieResultaten, afgewerkt = afgewerkt, MeetnetDetails = MeetnetDetails)
```


Ten slotte vermenigvuldigen we de gemiddelde volumes hout per boomsoort met de oppervlakte productief bos.
De standaardfout op het totale volume hout bereken via onderstaande formule.

$$\left(\frac{se_{V_{tot}}}{\hat{V}_{tot}}\right)^2 = \left(\frac{se_{V_{mean}}}{\hat{V}_{mean}}\right)^2  + \left(\frac{se_{A_{prod}}}{\hat{A_{prod}}}\right)^2$$

```{r}
Resultaat_bms_Vl <- Resultaat_bms %>%
    left_join(bosopp_productief, by = "periode") %>%
    mutate(wgt.mean_vol_tot =  round(wgt.mean * opp_prd_bos, 0),
          se_vol_mean = (wgt.var/nbObservaties)^0.5,
          se_vol_tot = ((se_bos_prod/opp_prd_bos)^2 + (se_vol_mean/wgt.mean)^2)^0.5 * wgt.mean_vol_tot,
          llci_vol_tot = round(wgt.mean_vol_tot - 1.96 * se_vol_tot, 0),
          ulci_vol_tot = round(wgt.mean_vol_tot + 1.96 * se_vol_tot, 0)) %>%
          arrange(wgt.mean_vol_tot) %>%
    mutate_at(vars, factor) 
```

```{r Grafiek}
# (alg) constanten grafiek----
H <- 12 # height = 8
W <- 8 # width = 8 ; of ev. 10 als lange titel
size_theme <- 13  # standaard inbo_theme met 12 als default size
size_title <- 18 # of ev. 14 als titel te lang is
size_facettxt <- 12
size_legendtitle <- 12
size_Xas <-12

# (alg) breedte errorbar, offset en dodge----
errorstr_width <- 0.125 # width=.125
errorstr_dodge_widt <- 0.5      # position_dodge(width=0.5)
label_value_dodge <- 0.5  
label_value_vjust <- 1.5
label_value_size <- 3.1 

titel <- paste ("Totaal volume per boomsoort (m³)", sep="")

Yas_label <- 'totaal volume (miljoen m³)'
Xas_label <- " "
output <- "Totaal volume per boomsoort"
output_graph <- output
output_graph <- "Totaal volume per boomsoort"  # soms beknopter nodig om extra info te kunne toevoegen
locatie <- "Output/Grafieken_tmp"   # locatie output

# grafiek----
df <- Resultaat_bms_Vl %>%
  filter(stratumNaam %in% c("Gewone esdoorn","Gewone es", "Fijnspar", "Wilg","Amerikaanse eik","Zwarte els" , "Beuk", "Berk", "Populier", "Corsicaanse den", "Inlandse eik", "Grove den"))

# DATA : labels en factoren ifv grafiek---

if (max(afgewerkt) == 0){
    a1 <- paste0(1997, "-", 1999)
    a2 <- paste0(2009, "-", 2019)
} else if (max(afgewerkt)!= 0){
    a1 <- paste0(1998, "-", startVBI3 -11 + max(afgewerkt) ) #1998 als gemiddeld van 1997-1999, blijft 9 reeksen lang het beginjaar # -11 omdat in 2009 zelf ook is gemeten
    a2 <- paste0(startVBI3  -10 + max(afgewerkt), "-", startVBI3 + max(afgewerkt) -1)
}


df$VBI <- factor(ifelse(df$periode ==-20, a1,a2 ))

VBI_geord <- c(a2, a1) 
stratumn_geord <- c("Gewone esdoorn","Gewone es", "Fijnspar", "Wilg","Amerikaanse eik","Zwarte els" , "Beuk", "Berk", "Corsicaanse den", "Populier", "Inlandse eik", "Grove den")

df <- df %>% 
  mutate(VBI = factor(VBI, levels = VBI_geord)) %>% 
  mutate(stratumNaam = factor(stratumNaam, levels = stratumn_geord))

g <- ggplot(df, aes(x = stratumNaam, y = wgt.mean_vol_tot/10^6, fill = VBI)) + 
  geom_bar(stat = "identity", position = "dodge", width = 0.5) +
   geom_errorbar(aes(ymin = llci_vol_tot/10^6, ymax = ulci_vol_tot/10^6), position=position_dodge(width=errorstr_dodge_widt), width=errorstr_width) + 
  geom_text(aes(x=stratumNaam, y=wgt.mean_vol_tot/10^6,label = paste(round(wgt.mean_vol_tot/10^6,1), sep = " ")), colour= "black", position=position_dodge(width=label_value_dodge),vjust=label_value_vjust,size = 2.5) + 
  scale_x_discrete(name = '') +
  # scale_y_continuous(name = Yas_label, limits = c(0,.6), breaks = seq(0, 0.6, 0.1), minor_breaks = seq(0,0.6, 0.05), labels = scales::percent) +
  scale_y_continuous(name = Yas_label, limits = c(0,10), breaks = seq(0, 10, 1), minor_breaks = seq(0, 10, 0.5 )) +
  coord_flip() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))  + 
  theme(legend.title=element_blank(), legend.text=element_text(size=size_legendtitle), legend.position="top") 

ggsave(plot = g, filename = here::here(paste0("Output/grafieken_tmp/TotaalVolumeBoomsoort_", a1,"&", a2, ".jpeg")))
g

```

```{r resultatendb_periode1vs2_toestand_bms_Vl}
# Toestand
Resultaat_bms_Vl <- Resultaat_bms_Vl %>% 
      filter(!is.na(stratumNaam) & stratumNaam != '<NA>')

My.ResultsToDatabase(dbHandle = dbResultaten_path
                      , tblName = "tblResultaten"
                      , results = Resultaat_bms_Vl
                      , scriptName = "GEG_LULUCF_VolumeBiomassCarbon_MethodeFRL_TreeLevel.Rmd"
                      , type="D"
                      , description = paste0("Totaal Volume (m3) - cfr FRL & INBO-advies A.4103 (meth. 4b)", reeksinfo,"  - top ", nrow(top_n_trees)," bms" )
                      , forestedge = "met randplots"
                      , datasource = dbAnalyseDataTxt
                      , datasource_hash = as.character(md5(dbAnalyseData_path))
                      , request_from = "VMM - LULUCF"
                      , run_by = run
                      , scriptLocation = "3DendroKwant"
                       )


```

```{r resultatendb_evolutie_bms}
# My.ResultsToDatabase: enkel bij analyseTypoe = M, wordt er weggeschreven naar tblResultaten_Verschil
# Anders steeds naar tblResultaten_toestand

results_toename_bms <- as.data.frame(Resultaat_wide_bms) %>%
  dplyr::select(-periode_1, -periode_2, -increase) %>% 
  mutate(periode = NA
         , wgt.mean = increase_per_yr   #♀ as.numeric(as.character(increase_per_yr))
         , wgt.var = NA
         , minYear = 1997
         , maxYear = startVBI3 + max(afgewerkt) -1
         , minReeks = 1
         , maxReeks = 10
         , nbObservaties = NA
         , llci = NA #as.numeric(as.character(llci))
         , ulci = NA #as.numeric(as.character(ulci))  
         ) %>%
  dplyr::select(variabele, periode, everything()) %>%
      mutate_at(.vars = vars, factor) 

My.ResultsToDatabase(dbHandle = dbResultaten_path
                        , tblName = "tblResultaten"
                        , results = results_toename_bms
                        , scriptName = "GEG_LULUCF_VolumeBiomassCarbon_MethodeFRL_TreeLevel.Rmd"
                        , type="D"
                        , description = paste0("Toename in volume (m3/ha/jr) - cfr FRL & INBO-advies A.4103 (meth. 4b)", reeksinfo,"  - top ", nrow(top_n_trees)," bms" )
                       , forestedge = "met randplots"
                       , datasource =paste(str_extract(dbAnalyseData ,"VBI_Analysedatabank.+"), "&", str_extract(dbMeetproces ,"VBI_Meetproces.+"))
                       , datasource_hash = as.character(md5(dbAnalyseData_path))
                       , request_from = "VMM - LULUCF"
                       , run_by = run
                       , scriptLocation = "3DendroKwant")
```


```{r export_to_csv, include=FALSE}
write_excel_csv2(Resultaat_wide,here::here("Output/Tabellen_tmp/resultVolumeBiomassCarbonUptake_MethodeFRL_TreeLevel.csv"))
```



# Model based analyse alle boomsoorten


```{r}
# Voortschrijdend gemiddelde, twee voorbije decennia-----

df20 <- get_last_20y(analyseSet2, Afgewerkt = afgewerkt) %>%
    inner_join(tbl_PlotDetails, by = c("IDPlots", c("VBI" = "Periode"))) %>% # IDGroup
    filter(!is.na(IDGroup))
 
Model.lmer_20 <- lmer(formula =  StemVolume_m3_ha ~ fPeriode + (1|IDGroup), data = df20 , weight=Weight)

summary(Model.lmer_20)
plot(Model.lmer_20)


df20$E<-resid(Model.lmer_20)
qqnorm(df20$E)
ggplot(df20,aes(x=fPeriode,y=E))+geom_boxplot()

ggplot(df20,aes(x=IDGroup,y=E,colour=fPeriode,group=IDGroup)) +
  geom_point()+geom_line() +
  labs(y="Residual",x="IDGepaard")

print(get_lmer_output(Model = Model.lmer_20))
```


```{r}
#nulmodel, nodig om toestand (vs verschil) te berekenen/weg te schrijven naar db
Model.lmer_20_0 <- lmer( StemVolume_m3_ha ~ 0 + fPeriode + (1|IDGroup), data = df20,
                                 weight=Weight)
summary(Model.lmer_20_0)
plot(Model.lmer_20_0)

df20$E<-resid(Model.lmer_20_0)
qqnorm(df20$E)
ggplot(df20,aes(x=fPeriode,y=E))+geom_boxplot()

ggplot(df20,aes(x=IDGroup,y=E,colour=fPeriode,group=IDGroup)) +
  geom_point()+geom_line() +
  labs(y="Residual",x="IDGepaard")



print(get_lmer_output(Model.lmer_20_0))
```

## Schatting StemVolume_m3_ha TOESTAND per periode

```{r}
results.toestand <- My.ParametersMB(Data = df20, VariableName = "StemVolume_m3_ha",
                                    GLMERModel = Model.lmer_20_0, Type = "toestand")

results.toestand
results.toestand$Periode <- as.factor(results.toestand$Periode )

My.ResultsToDatabase(results = results.toestand
                     , dbHandle = dbResultaten_path
                     , tblName = "tblResultaten"
                     , scriptName = "GEG_LULUCF_VolumeBiomassCarbon_MethodeFRL_TreeLevel.Rmd"
                     , type="M"
                     , description = paste0("Volume (m3/ha) - cfr FRL & INBO-advies A.4103 (meth. 4b)", reeksinfo)
                     , forestedge = "met randplots"
                     , scriptLocation = "3DendroKwant"
                     , datasource = dbAnalyseDataTxt
                     , datasource_hash = as.character(md5(dbAnalyseData))
                     , request_from = " "
                     , run_by = run)
```

## Schatting StemVolume_m3_ha VERSCHIL tussen de twee periodes 

```{r}

results.verschil <-My.ParametersMB(Data = df20, VariableName = "StemVolume_m3_ha",GLMERModel = Model.lmer_20,Type = "verschil")

print(get_lmer_output(Model.lmer_20))
results.verschil

My.ResultsToDatabase(results = results.verschil
                     , dbHandle = dbResultaten_path
                     , tblName = "tblResultaten"
                     , scriptName = "GEG_LULUCF_VolumeBiomassCarbon_MethodeFRL_TreeLevel.Rmd"
                     , type="M"
                     , description = paste0("Toename in volume (m3/ha/jr) - cfr FRL & INBO-advies A.4103 (meth. 4b)", reeksinfo)
                     , forestedge = "met randplots"
                     , scriptLocation = "3DendroKwant"
                     , datasource = dbAnalyseDataTxt
                     , datasource_hash = as.character(md5(dbAnalyseData))
                     , request_from = " "
                     , run_by = run)

```

## Schatting Carbon_t_ha TOESTAND tussen de twee periodes 

```{r}
Model.lmer_20 <- lmer(formula =  Carbon_t_ha ~ fPeriode + (1|IDGroup), data = df20 , weight=Weight)

summary(Model.lmer_20)
plot(Model.lmer_20)
df20$E<-resid(Model.lmer_20_0)
qqnorm(df20$E)
ggplot(df20,aes(x=fPeriode,y=E))+geom_boxplot()

ggplot(df20,aes(x=IDGroup,y=E,colour=fPeriode,group=IDGroup)) +
  geom_point()+geom_line() +
  labs(y="Residual",x="IDGepaard")

print(get_lmer_output(Model.lmer_20))
```


```{r}
#nulmodel, nodig om toestand (vs verschil) te berekenen/weg te schrijven naar db
Model.lmer_20_0 <- lmer( Carbon_t_ha ~ 0 + fPeriode + (1|IDGroup), data = df20,
                                 weight=Weight)
summary(Model.lmer_20_0)
plot(Model.lmer_20_0)

df20$E<-resid(Model.lmer_20_0)
qqnorm(df20$E)
ggplot(df20,aes(x=fPeriode,y=E))+geom_boxplot()

ggplot(df20,aes(x=IDGroup,y=E,colour=fPeriode,group=IDGroup)) +
  geom_point()+geom_line() +
  labs(y="Residual",x="IDGepaard")

print(get_lmer_output(Model.lmer_20_0))
```


```{r}
results.toestand <- My.ParametersMB(Data = df20, VariableName = "Carbon_t_ha",
                                    GLMERModel = Model.lmer_20_0, Type = "toestand")

results.toestand
results.toestand$Periode <- as.factor(results.toestand$Periode )

My.ResultsToDatabase(results = results.toestand
                     , dbHandle = dbResultaten_path
                     , tblName = "tblResultaten"
                     , scriptName = "GEG_LULUCF_VolumeBiomassCarbon_MethodeFRL_TreeLevel.Rmd"
                     , type="M"
                     , description = paste0("Carbon_t_ha - cfr FRL & INBO-advies A.4103 (meth. 4b)", reeksinfo)
                     , forestedge = "met randplots"
                     , scriptLocation = "3DendroKwant"
                     , datasource = dbAnalyseDataTxt
                     , datasource_hash = as.character(md5(dbAnalyseData))
                     , request_from = " "
                     , run_by = run)
```

## Schatting Carbon_t_ha VERSCHIL tussen de twee periodes 

```{r}

results.verschil <-My.ParametersMB(Data = df20, VariableName = "Carbon_t_ha",GLMERModel = Model.lmer_20,Type = "verschil")

print(get_lmer_output(Model.lmer_20))
results.verschil

My.ResultsToDatabase(results = results.verschil
                     , dbHandle = dbResultaten_path
                     , tblName = "tblResultaten"
                     , scriptName = "GEG_LULUCF_VolumeBiomassCarbon_MethodeFRL_TreeLevel.Rmd"
                     , type="M"
                     , description = paste0("Toename in Carbon_t_ha - cfr FRL & INBO-advies A.4103 (meth. 4b)", reeksinfo )
                     , forestedge = "met randplots"
                     , scriptLocation = "3DendroKwant"
                     , datasource = dbAnalyseDataTxt
                     , datasource_hash = as.character(md5(dbAnalyseData))
                     , request_from = " "
                     , run_by = run)

```

## Jaarlijkse uptake van carbon per ha 

Delen door een constante : ook llci en ulci delen door zelfde factor

```{r}
results.verschil_y <- results.verschil %>%
    mutate(increase_y = Verschil/mtimelaps
           , Llci_y = Llci/mtimelaps
           , Ulci_y = Ulci/mtimelaps) %>%
    dplyr::select(-Verschil, -Llci, -Ulci) %>%
    mutate(Variable = 'Carbon_t_ha_jaar') %>%
    dplyr::select("Verschil"= "increase_y", "Llci" = "Llci_y", "Ulci" = "Ulci_y", everything())    


results.verschil_y %>% DT::datatable()

My.ResultsToDatabase(results = results.verschil_y
                     , dbHandle = dbResultaten_path
                     , tblName = "tblResultaten"
                     , scriptName = "GEG_LULUCF_VolumeBiomassCarbon_MethodeFRL_TreeLevel.Rmd"
                     , type="M"
                     , description = paste0("Toename in Carbon_t_ha per jaar - cfr FRL & INBO-advies A.4103 (meth. 4b)", reeksinfo )
                     , forestedge = "met randplots"
                     , scriptLocation = "3DendroKwant"
                     , datasource = dbAnalyseDataTxt
                     , datasource_hash = as.character(md5(dbAnalyseData))
                     , request_from = " "
                     , run_by = run)

```

